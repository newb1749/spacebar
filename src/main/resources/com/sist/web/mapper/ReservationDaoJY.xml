<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sist.web.dao.ReservationDaoJY">

  <resultMap id="reservationResultMap" type="com.sist.web.model.ReservationJY">
    <id property="rsvSeq" column="RSV_SEQ" />
    <result property="guestId" column="GUEST_ID" />
    <result property="hostId" column="HOST_ID" />
    <result property="rsvCheckInDt" column="RSV_CHECK_IN_DT" />
    <result property="rsvCheckOutDt" column="RSV_CHECK_OUT_DT" />
    <result property="rsvCheckInTime" column="RSV_CHECK_IN_TIME" />
    <result property="rsvCheckOutTime" column="RSV_CHECK_OUT_TIME" />
    <result property="numGuests" column="NUM_GUESTS" />
    <result property="totalAmt" column="TOTAL_AMT" />
    <result property="finalAmt" column="FINAL_AMT" />
    <result property="rsvStat" column="RSV_STAT" />
    <result property="rsvPaymentStat" column="RSV_PAYMENT_STAT" />
    <result property="cancelDt" column="CANCEL_DT" />
    <result property="cancelReason" column="CANCEL_REASON" />
    <result property="refundAmt" column="REFUND_AMT" />
    <result property="guestMsg" column="GUEST_MSG" />
    <result property="hostMsg" column="HOST_MSG" />
    <result property="regDt" column="REG_DT" />
    <result property="updateDt" column="UPDATE_DT" />
    <result property="roomTypeSeq" column="ROOM_TYPE_SEQ" />
  </resultMap>

  <!-- 예약 등록 -->
  <insert id="insertReservation" parameterType="com.sist.web.model.ReservationJY" useGeneratedKeys="true" keyProperty="rsvSeq" keyColumn="RSV_SEQ">
  INSERT INTO RESERVATION (
    RSV_SEQ,
    GUEST_ID,
    HOST_ID,
    RSV_CHECK_IN_DT,
    RSV_CHECK_OUT_DT,
    RSV_CHECK_IN_TIME,
    RSV_CHECK_OUT_TIME,
    NUM_GUESTS,
    TOTAL_AMT,
    FINAL_AMT,
    RSV_STAT,
    RSV_PAYMENT_STAT,
    CANCEL_DT,
    CANCEL_REASON,
    REFUND_AMT,
    GUEST_MSG,
    HOST_MSG,
    REG_DT,
    UPDATE_DT,
    ROOM_TYPE_SEQ
  )
  VALUES (
    SEQ_RESERVATION_SEQ.NEXTVAL,
    #{guestId,jdbcType=VARCHAR},
    #{hostId,jdbcType=VARCHAR},
    #{rsvCheckInDt,jdbcType=DATE},
    #{rsvCheckOutDt,jdbcType=DATE},
    #{rsvCheckInTime,jdbcType=TIME},
    #{rsvCheckOutTime,jdbcType=TIME},
    #{numGuests,jdbcType=INTEGER},
    #{totalAmt,jdbcType=INTEGER},
    #{finalAmt,jdbcType=INTEGER},
    #{rsvStat,jdbcType=VARCHAR},
    #{rsvPaymentStat,jdbcType=VARCHAR},
    #{cancelDt,jdbcType=DATE},
    #{cancelReason,jdbcType=VARCHAR},
    #{refundAmt,jdbcType=INTEGER},
    #{guestMsg,jdbcType=VARCHAR},
    #{hostMsg,jdbcType=VARCHAR},
    SYSDATE,
    SYSDATE,
    #{roomTypeSeq,jdbcType=INTEGER}
  )
</insert>

  <!-- 게스트 ID로 예약 리스트 조회 -->
  <select id="selectReservationsByGuestId" resultMap="reservationResultMap" parameterType="String">
    SELECT 
      RSV_SEQ,
      GUEST_ID,
      HOST_ID,
      RSV_CHECK_IN_DT,
      RSV_CHECK_OUT_DT,
      RSV_CHECK_IN_TIME,
      RSV_CHECK_OUT_TIME,
      NUM_GUESTS,
      TOTAL_AMT,
      FINAL_AMT,
      RSV_STAT,
      RSV_PAYMENT_STAT,
      CANCEL_DT,
      CANCEL_REASON,
      REFUND_AMT,
      GUEST_MSG,
      HOST_MSG,
      REG_DT,
      UPDATE_DT,
      ROOM_TYPE_SEQ
    FROM RESERVATION
    WHERE GUEST_ID = #{guestId}
    ORDER BY RSV_SEQ DESC
  </select>

  <!-- 예약 번호로 상세 조회 -->
  <select id="selectReservationBySeq" resultMap="reservationResultMap" parameterType="int">
    SELECT 
      RSV_SEQ,
      GUEST_ID,
      HOST_ID,
      RSV_CHECK_IN_DT,
      RSV_CHECK_OUT_DT,
      RSV_CHECK_IN_TIME,
      RSV_CHECK_OUT_TIME,
      NUM_GUESTS,
      TOTAL_AMT,
      FINAL_AMT,
      RSV_STAT,
      RSV_PAYMENT_STAT,
      CANCEL_DT,
      CANCEL_REASON,
      REFUND_AMT,
      GUEST_MSG,
      HOST_MSG,
      REG_DT,
      UPDATE_DT,
      ROOM_TYPE_SEQ
    FROM RESERVATION
    WHERE RSV_SEQ = #{rsvSeq}
  </select>

  <!-- 예약 상태 업데이트 -->
  <update id="updateReservationStatus" parameterType="map">
    UPDATE RESERVATION
    SET RSV_STAT = #{status},
        UPDATE_DT = SYSDATE
    WHERE RSV_SEQ = #{rsvSeq}
  </update>

  <!-- 결제 상태 업데이트 -->
  <update id="updatePaymentStatus" parameterType="map">
    UPDATE RESERVATION
    SET RSV_PAYMENT_STAT = #{paymentStatus},
        UPDATE_DT = SYSDATE
    WHERE RSV_SEQ = #{rsvSeq}
  </update>

  <!-- 예약 취소 처리 -->
  <update id="cancelReservation" parameterType="com.sist.web.model.ReservationJY">
    UPDATE RESERVATION
    SET RSV_STAT = '취소',
        RSV_PAYMENT_STAT = '취소',
        CANCEL_DT = SYSDATE,
        CANCEL_REASON = #{cancelReason},
        REFUND_AMT = #{refundAmt},
        UPDATE_DT = SYSDATE
    WHERE RSV_SEQ = #{rsvSeq}
  </update>
  
  <select id="selectReservationById" parameterType="int" resultType="com.sist.web.model.ReservationJY">
  SELECT 
    RSV_SEQ,
    GUEST_ID,
    HOST_ID,
    RSV_CHECK_IN_DT,
    RSV_CHECK_OUT_DT,
    RSV_CHECK_IN_TIME,
    RSV_CHECK_OUT_TIME,
    NUM_GUESTS,
    TOTAL_AMT,
    FINAL_AMT,
    RSV_STAT,
    RSV_PAYMENT_STAT,
    CANCEL_DT,
    CANCEL_REASON,
    REFUND_AMT,
    GUEST_MSG,
    HOST_MSG,
    REG_DT,
    UPDATE_DT,
    ROOM_TYPE_SEQ
  FROM RESERVATION
  WHERE RSV_SEQ = #{rsvSeq}
</select>
  
  <select id="selectHostIdByRoomSeq" parameterType="int" resultType="String">
    SELECT HOST_ID FROM ROOM WHERE ROOM_SEQ = #{roomSeq}
</select>
  

</mapper>

<mapper namespace="com.sist.web.dao.CouponDaoJY">

  <!-- 기존 쿠폰 조회 쿼리 -->
  <select id="selectAllCoupons" resultMap="couponResultMap">
    SELECT NVL(CPN_SEQ, 0) CPN_SEQ,
           NVL(CPN_NAME, '') CPN_NAME,
           NVL(CPN_DESC, '') CPN_DESC,
           NVL(DISCOUNT_RATE, 0) DISCOUNT_RATE,
           NVL(DISCOUNT_AMT, 0) DISCOUNT_AMT,
           NVL(MIN_ORDER_AMT, 0) MIN_ORDER_AMT,
           NVL(TO_CHAR(ISSUE_START_DT, 'YYYY-MM-DD'), '') ISSUE_START_DT,
           NVL(TO_CHAR(ISSUE_END_DT, 'YYYY-MM-DD'), '') ISSUE_END_DT,
           NVL(CPN_TYPE, '') CPN_TYPE,
           NVL(CPN_STAT, '') CPN_STAT,
           NVL(TOTAL_CPN_CNT, 0) TOTAL_CPN_CNT,
           NVL(TO_CHAR(REG_DT, 'YYYY-MM-DD'), '') REG_DT,
           NVL(TO_CHAR(UPDATE_DT, 'YYYY-MM-DD'), '') UPDATE_DT
      FROM COUPON
     ORDER BY CPN_SEQ DESC
  </select>

  <!-- 유저가 쿠폰 이미 발급했는지 확인 -->
  <select id="countUserCoupon" parameterType="map" resultType="int">
    SELECT COUNT(*) FROM USER_COUPON
     WHERE USER_ID = #{userId}
       AND CPN_SEQ = #{cpnSeq}
       AND NVL(USER_CPN_IS_USED, 'N') = 'N'  <!-- 미사용 쿠폰만 카운트 -->
  </select>

  <!-- 쿠폰 발급 -->
  <insert id="insertUserCoupon" parameterType="map">
    INSERT INTO USER_COUPON (
      USER_CPN_SEQ,
      USER_ID,
      CPN_SEQ,
      ISSUE_DT,
      USER_CPN_IS_USED,
      USER_CPN_CNT
    )
    VALUES (
      USER_CPN_SEQ.NEXTVAL,
      #{userId},
      #{cpnSeq},
      SYSDATE,
      'N',
      1
    )
  </insert>

</mapper>
